PayME SDK is a set of libraries for apps to interact with PayME Platform. PayME SDK includes the following main functions:

- Registration, login, eKYC system through PayME wallet account

- Deposit and withdrawal function from PayME wallet.

- Integration of services of PayME Platform.


**Some terms**

| | Name | Explanation |
| :--- | :----- | ---------------------------------------------------  |
| 1 | app | Is an iOS/Android mobile app or a web that will integrate the SDK to perform the PayME wallet payment function. |
| 2 | SDK | Is a toolkit to support the integration of PayME wallet into the app system. |
| 3 | backend | An integrated system that supports an app, server or api that supports |
| 4 | AES | AES data encryption function. [Reference](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard) |
| 5 | RSA | RSA data encryption algorithm. |
| 6 | IPN | Instant Payment Notification , used to notify between the app's backend and PayME's backend |

### PayME SDK Error Code
| Constant | Error Code | Explanation
| -------------- | ---------- | -------- |
| `EXPIRED` | `401` | token expires |
| `ACCOUNT_LOCK` | `405` | actively locked account |
| `NETWORK` | `-1` | Network connection problem |
| `SYSTEM` | `-2` | System Error |
| `LIMIT` | `-3` | Error of insufficient balance to make a transaction |
| `NOT_ACTIVATED` | `-4` | Account not activated error |
| `KYC_NOT_APPROVED` | `-5` | Unapproved account error |
| `PAYMENT_ERROR` | `-6` | Payment failed |
| `ERROR_KEY_ENCODE` | `-7` | Data encryption/decryption error |
| `USER_CANCELLED` | `-8` | User cancels |
| `NOT_LOGIN` | `-9` | Error account not logged in |
| `BALANCE_ERROR` | `-11` | Insufficient wallet balance error |
| `UNKNOWN_PAYCODE` | `-12` | Error missing payCode information |


## Install
- npm:
```shell
npm install expo-payme-sdk
```

- yarn:
```shell
yarn add expo-payme-sdk
```

## Install dependent library

```shell
expo install expo-contacts
```

## Usage

The PayME system will provide the integrated app with the following information:

- **PublicKey** : Used to encrypt data, the integrated app needs to be transmitted to the SDK for encryption.

- **AppToken** : AppToken provides a separate identifier for each app, needs to be passed to the SDK for encryption

- **SecretKey** : Used to encrypt and authenticate data in the backend system for the integrated app.

The App side will provide the PayME system with the following information:

- **AppPublicKey** : It will be sent through PayME's backend system for encryption.

- **AppPrivateKey**: Will pass in PayME SDK to perform decryption.

Encryption standard: RSA-512bit.

### Initializing the library

Before using the PayME SDK, you need to import the ExpoPaymeSDK Component and pass the ref to initialize and use.

```javascript
import ExpoPaymeSDK from 'expo-payme-sdk';

export default function App() {
  const refExpoPaymeSDK = React.useRef(null);
  return
  (
    <>
      ...
      <RootNavigation />
      ...
      <ExpoPaymeSDK ref={refExpoPaymeSDK}  />
      </>
  )
}
```

### Functions of PayME SDK
Before using PayME SDK need to call login() :

#### login

There are 2 cases

- Used to login for the first time immediately after initializing PayME.

- Used when the accessToken expires, when calling the SDK function that returns the error code ERROR_CODE.EXPIRED or ERROR_CODE.ACCOUNT_LOCK, now the app needs to call login again to get the accessToken for other functions.

After calling login() successfully, then call other functions of the SDK ( openWallet, pay, ... )

```javascript
const configs = {
	connectToken,
	appToken,
	deviceId,
	env,
	configColor,
	publicKey,
	privateKey,
	appID,
	phone
}
refExpoPaymeSDK.current.login(
  configs,
  onSuccess: (response: any) => void,
  onError: (error: any) => void,
)
```

#### Constant

| Property | Type | Description |
| ------------------- | ------ | ---------------------- |
| `ENV.SANDBOX` | `enum` | Sandbox environment. |
| `ENV.PRODUCTION` | `enum` | Production environment. |

#### Parameters

| Property | Type | Description |
| -------------- | ---------- | --------------------------------------------------- |
| `appToken` | `string` | AppId provides a unique identifier for each app, which needs to be passed to the SDK for encryption. |
| `publicKey` | `string` | For data encryption, the built-in app needs to pass it to the SDK for encryption. Due to the PayME system provided for the integrated app. |
| `privateKey` | `string` | app needs to pass in to decode the data. The app side will provide the PayME system. |
| `connectToken` | `string` | app needs to pass the value given above, see how to create it below. |
| `deviceId` | `string` | Is the deviceId of the device |
| `appID` | `string` | Is the appID when registering merchant sdk will be generated by the system for |
| `phone` | `string` | Phone number of the system integrator |
| `configColor` | `string[]` | configColor : is the color parameter to be able to change the color of PayME wallet transactions, the data type is string with

configColor : is the color parameter to be able to change the color of PayME wallet transactions, the data type is string with the format #rrggbb. If 2 colors are transmitted, the PayME interface will gradient according to the 2 input colors.

[![img](https://github.com/PayME-Tech/PayME-SDK-Android-Example/raw/main/fe478f50-e3de-4c58-bd6d-9f77d46ce230.png?raw=true)](https://github.com/PayME-Tech/PayME-SDK-Android-Example/blob/main/fe478f50-e3de-4c58-bd6d-9f77d46ce230.png?raw=true)

How to create **connectToken**:

connectToken needed for transmission call the api from to PayME and will be generated from the backend of the integrated app. The structure is as follows:

- ***Nodejs Example***

```javascript
import crypto from 'crypto'

const data = {
	timestamp: "2021-01-20T06:53:07.621Z",
	userId: "abc",
	phone: "0123456789"
}
const algorithm = `aes-256-cbc`
const ivbyte = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
const iv = Buffer.from(ivbyte)

const cipher = crypto.createCipheriv(algorithm, secretKey, iv)

const encrypted = cipher.update(JSON.stringify(data), 'utf8', 'base64')

const connectToken = encrypted + cipher.final('base64')
```

- ***Expo Example***

```javascript
import forge from 'node-forge'

function encryptAES(text, secretKey) {
  const ivbyte = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
  const cipher = forge.cipher.createCipher('AES-CBC', secretKey)
  cipher.start({ iv: ivbyte })
  cipher.update(forge.util.createBuffer(text, 'utf8'))
  cipher.finish()
  return forge.util.encode64(cipher.output.getBytes())
}

const data = {
  timestamp: "2021-01-20T06:53:07.621Z",
	userId: "abc",
	phone: "0123456789"
};

const connectToken = encryptAES(JSON.stringify(data), appSecretkey)
```

Generate connectToken including KYC information (For partners with their own KYC system)

```javascript
const data = {
  timestamp: "2021-01-20T06:53:07.621Z",
  userId : "abc",
  phone : "0123456789",
  kycInfo: {
    fullname: "Nguyễn Văn A",
    gender: "MALE",
    birthday: "1995-01-20T06:53:07.621Z",
    address: "15 Nguyễn cơ thạch",
    identifyType: "CMND",
    identifyNumber: "142744332",
    issuedAt: "2013-01-20T06:53:07.621Z",
    placeOfIssue: "Hồ Chí Minh",
    video: "https://file-examples-com.github.io/uploads/2017/04/file_example_MP4_480_1_5MG.mp4",
    face: "https://cdn.pixabay.com/photo/2015/04/23/22/00/tree-736885__480.jpg",
    image: {
      front: "https://cdn.pixabay.com/photo/2015/04/23/22/00/tree-736885__480.jpg",
      back: "https://cdn.pixabay.com/photo/2015/04/23/22/00/tree-736885__480.jpg"
    }
  }
};

const connectToken = encryptAES(JSON.stringify(data), appSecretkey)
```

| **Parameters** | **Required** | **Explanation** |
| :----------- | :---------- | :------------------------------------------------- |
| **timestamp** | Yes | The time of creating connectToken in the format iSO 8601 , Used to determine the timeout time of connectToken. Example 2021-01-20T06:53:07,621Z |
| ***userId*** | Yes | is a unique fixed value corresponding to each customer account in the service, usually this value is provided by the integrated system server for the PayME SDK |
| ***phone*** | No | Phone number of the system integrator |

Where ***AES*** is the encryption function according to the AES algorithm. Depending on the language on the server, the system side uses the corresponding library. See more here https://en.wikipedia.org/wiki/Advanced_Encryption_Standard

KycInfo Parameters

| **Parameters** | **Required** | **Explanation** |
| :----------- | :---------- | :------------------------------------------------- |
| fullname | Yes | Full name |
| gender | Yes | Gender ( MALE/FEMALE) |
| address | Yes | Address |
| identifyType | Yes | Type of document (ID/CCCD) |
| identifyNumber | Yes | Number of papers |
| issuedAt | Yes | Registration date |
| placeOfIssue | Yes | Place of issue |
| video | No | video link |
| face | No | path to face photo |
| front | No | link to a photo of the front of the document |
| back | No | link to photo of the back of the document |


#### getAccountInfo

App can use this property after SDK initialization to know the link status to PayME wallet.

```javascript
refExpoPaymeSDK.current.getAccountInfo(
  onSuccess: (response: any) => void,
  onError: (error: any) => void,
)
```

#### openWallet - Opens the PayME composite function UI

This function is called when from the built-in app when you want to call a PayME function by passing the Action parameter as above.

```javascript
refExpoPaymeSDK.current.openWallet(
  onSuccess: (response: any) => void,
  onError: (error: any) => void,
)
```

#### openHistory
This function is called when from the built-in app when you want to open the transaction history from the wallet.

** Requires activated account and identity to open Wallet history

⚠️⚠️⚠️ version 0.3.1 and later

```javascript
refExpoPaymeSDK.current.openHistory(
  onSuccess: (response: any) => void,
  onError: (error: any) => void,
)
```

#### deposit - Deposit Money

```javascript
refExpoPaymeSDK.current.deposit(
	{
    amount: Number,
    description: String,
    extraData: String,
    closeWhenDone: Boolean,
  },
  onSuccess: (response: any) => void,
  onError: (error: any) => void
);
```

| **Parameters** | **Required** | **Explanation** |
| :------------------------------------------------- | :---------- | :------------------------------------------------- |
| [amount](https://www.notion.so/amount-34eb8b97a9d04453867a7e4d87482980) | Yes| Used in case the action is Deposit/Withdraw, then enter the amount |
| [description](https://www.notion.so/description-59034b8b0afe4f90a9118da3a478e7c0) | Yes| Transaction description if available |
| [extraData](https://www.notion.so/extraData-60ec44734315404685d82f9ab1d2886a) | No | When performing Deposit or Withdraw, the integrated app needs to transmit other data if desired so that the PayME backend system can IBN back to the opposite integrated backend app system. For example: the transactionID of the transaction or any other data needed by the integrated app system. |
| closeWhenDone | Yes | true: Close SDK on completion of transaction |
| onSuccess | Yes | Used to catch callback when making a successful transaction from PayME SDK |
| onError | Yes | Used to catch callback when an error occurs during calling PayME SDK |

#### withdraw - Withdraw Money

```javascript
refExpoPaymeSDK.current.withdraw(
	{
    amount: Number,
    description: String,
    extraData: String,
    closeWhenDone: Boolean,
  },
  onSuccess: (response: any) => void,
  onError: (error: any) => void
);
```

| **Parameters** | **Required** | **Explanation** |
| :-------------------------------------------------  | :---------- | :------------------------------------------------- |
| [amount](https://www.notion.so/amount-34eb8b97a9d04453867a7e4d87482980) | Yes| Used in case the action is Deposit/Withdraw, then enter the amount |
| [description](https://www.notion.so/description-59034b8b0afe4f90a9118da3a478e7c0) | Yes| Transaction description if available |
| [extraData](https://www.notion.so/extraData-60ec44734315404685d82f9ab1d2886a) | No | When performing Deposit or Withdraw, the integrated app needs to transmit other data if desired so that the PayME backend system can IBN back to the opposite integrated backend app system. For example: the transactionID of the transaction or any other data needed by the integrated app system. |
| closeWhenDone | Yes | true: Close SDK on completion of transaction |
| onSuccess | Yes | Used to catch callback when making a successful transaction from PayME SDK |
| onError | Yes | Used to catch callback when an error occurs during calling PayME SDK |

#### transfer - Transfer money
```javascript
refExpoPaymeSDK.current.transfer(
	{
    amount: Number,
    description: String,
    closeWhenDone: Boolean,
  },
  onSuccess: (response: any) => void,
  onError: (error: any) => void
);
```

| **Parameters** | **Required** | **Explanation** |
| :-------------------------------------------------  | :---------- | :------------------------------------------------- |
| [amount](https://www.notion.so/amount-34eb8b97a9d04453867a7e4d87482980) | Yes| Used in case the action is Deposit/Withdraw, then enter the amount |
| [description](https://www.notion.so/description-59034b8b0afe4f90a9118da3a478e7c0) | Yes| Transaction description if available |
| closeWhenDone | Yes | true: Close SDK on completion of transaction |
| onSuccess | Yes | Used to catch callback when making a successful transaction from PayME SDK |
| onError | Yes | Used to catch callback when an error occurs during calling PayME SDK |

#### scanQR() - Opens QR code scanning for payment

```javascript
refExpoPaymeSDK.current.scanQR(
      {
        payCode: String
      },
      onSuccess: (response: any) => void,
      onError: (error: any) => void,
);
```

| **Parameters** | **Required** | **Explanation** |
| :------------------------------------------------- | :---------- | :------------------------------------------------- |
| payCode | Yes | [Payment Method List](#list-method-payment) |

qr format:
```javascript
const qrString = "{$type}|${storeId}|${action}|${amount}|${note}|${orderId}|${userName}"
```

Example:
```javascript
const qrString = "OPENEWALLET|54938607|PAYMENT|20000|Chuyentien|2445562323|taikhoan"
```

- action: transaction type ( 'PAYMENT' => payment)
- amount: payment amount
- note: Description of the transaction from the counterparty
- orderId: the partner's transaction code, which needs to be unique on each transaction. Maximum 22 characters.
- storeId: ID of the public store that made the payment
- userName: Account name
- type: OPENEWALLET

#### payQRCode() - payment QR code

```javascript
refExpoPaymeSDK.current.payQRCode(
      {
        qr: String,
        isShowResultUI: Boolean,
        payCode: String
      },
      onSuccess: (response: any) => void,
      onError: (error: any) => void
);
```

**Parameters** | **Required** | **Explanation** |
| :------------------------------------------------- | :---------- | :------------------------------------------------- |
| qr | Yes | QR code for payment (QR format like scanQR function) |
| isShowResultUI | Yes | Option to display trading results UI |
| payCode | Yes | [Payment Method List](#list-method-payment) |

#### getListService

App can use this property after SDK initialization to get a list of services that PayME is providing

```javascript

refExpoPaymeSDK.current.getListService(
  onSuccess: (response: any) => void,
  onError: (error: any) => void,
)

```


#### openService

This function is called when from the built-in app when you want to call a service that PayME also provides by passing the serviceCode parameter as above

```javascript
refExpoPaymeSDK.current.openService(
  serviceCode: String,
  onSuccess: (response: any) => void,
  onError: (error: any) => void,
)
```

#### pay - Payment

This function is used when the app needs to pay an amount from the activated PayME wallet.

```javascript
const  data = {
  amount:  Number,
  orderId:  String,
  storeId:  Number?,
  userName: String?,
  extractData: String,
  note:  String,
  isShowResultUI: true,
  payCode: String
}

refExpoPaymeSDK.current.pay(
  data,
  onSuccess: (response: any) => void,
  onError: (error: any) => void,
);
```

| **Parameters** | **Required** | **Explanation** |
| :------------------------------------------------- | :---------- | :------------------------------------------------- |
| amount | Yes | The amount to be paid by the app is passed to the SDK. |
| note | No | Description of the transaction from the counterparty. |
| orderId | Yes | Partner transaction code, which needs to be unique on each transaction. Maximum 22 characters. |
| storeId | No | The ID of the payment public store that performed the payment transaction. |
| userName | No | Account name. |
| extractData | No | Additional Information (extraData) is a string defined content containing additional information of a transaction that the counterparty wants to receive when completing a transaction with PAYME. If the Merchant does not need IPN to add his custom data, he can ignore it. |
| isShowResultUI | Yes | Option to display the payment result UI. |
| payCode | Yes | [Payment Method List](#list-method-payment) |
| onSuccess | Yes | Used to catch callback when making a successful transaction from PayME SDK |
| onError | Yes | Used to catch callback when an error occurs during calling PayME SDK |

In case the built-in app needs to get the balance to display itself on the UI on the app, you can use the function, this function does not display the UI of the PayME SDK.
- When paying with PayME wallet, it is required that the activated account, identifier and balance in the wallet must be greater than the payment amount
- Account information is obtained through the getAccountInfo() function
- Balance information is obtained through the getWalletInfo function ()



#### getWalletInfo - Get wallet information

```javascript
refExpoPaymeSDK.current.getWalletInfo(
  onSuccess: (response: any) => void,
  onError: (error: any) => void,
)
```

```json
{
	"response": {
		"balance": 111,
		"detail": {
			"cash": 1,
			"lockCash": 2
		}
	}
}
```


*balance*: The built-in app can use the value in the balance key to display, other fields are currently unused.

*detail.cash*: Money can be used.

*detail.lockCash*: Money is locked.

## List of payment methods
| **payCode** | **Payment Method** |
| :-----------| :------------|
| PAYME | PayME wallet payment |
| ATM | Domestic ATM card payment |
| MANUAL_BANK | Bank transfer payment |
| CREDIT | Credit card payments |
| VIET_QR | VietQR payments |

## License
Copyright 2020 @ [PayME](payme.vn)
